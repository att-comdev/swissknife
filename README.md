# SwissKnife

SwissKnife is a small utility to rotate the ssl certs in a k8s cluster.

  - Makes use of Promenade to generate new certificates
  - Runs Ansible playbook to distribute the certs to the nodes

# Build
<!-- TODO(ian-pittwood): insert upstream url -->
 ```sh
    git clone ssh://<REPO_URL>/swissknife

    cd swissknife
    docker build --no-cache -t swissknife .
 ```

# Usage
Ansible playbooks use the local ips in the cluster to communicate. So its
recommended to run the below docker container from the genesis node.

####  Prerequisites
  - ssh-key for Ansible to login to the nodes
  - site specific manifests
  - global manifests
  - A local dir where the certificates.yaml generated by promenade to be saved
  - Copy ingress certs in that directory
  - Add kubectl binary in your home directory for faster execution.

```sh
  export KUBECONFIG=/etc/kubernetes/admin/kubeconfig.yaml
  if [ ! -f $HOME/kubectl ]; then
    CONTAINER=$(docker create "$(awk '/hyperkube-amd64/ { print $1 ; exit }' \
        /usr/local/bin/kubectl)")
    docker cp "$CONTAINER:/hyperkube" "$HOME/kubectl"
    chmod +x "$HOME/kubectl"
    docker rm "$CONTAINER"
  fi
  $HOME/kubectl get nodes
```

```sh
docker run  -u root  --rm -it \
  -v $(pwd)/target:/target \
  -v <path_to_site_specific_manifest>:/opt/site-manifests \
  -v <path_to_global_manifests>:/opt/global-manifests \
  -v <path_to_ssh_key>:/root/.ssh/id_rsa  \
  -e "ansible_user=<ansible_ssh_user>" \
  swissknife
```

#### Parameters:
  - path\_to\_site\_specific\_manifest: site specific manifest
  - path\_to\_global\_manifests: site manifest
  - path\_to\_ssh\_key: ssh-key for ansible to login to the nodes
  - ansible\_ssh\_user: user with sudo privileges for ansible \
                         to login to the nodes


example Usage:

```sh
docker run -u root --rm -it \
  -v $(pwd)/target:/target \
  -v $(pwd)/${SITE_MANIFESTS}/site/${SITE_NAME}:/opt/site-manifests \
  -v $(pwd)/${GLOBAL_MANIFESTS}:/opt/global-manifests \
  -v /root/.ssh/id_rsa:/root/.ssh/id_rsa  \
  -e "ansible_user=${SSH_USER}" att-comdev/swissknife
```
####Set Environment
TARGET_PATH : Location of the working directory, all the files are generated here.
SITE_MANIFEST : Location of site-manifests, full path to the site directory
GLOBAL_MANIFEST : Location of the global manifests, root directory.
PRIVATE_KEY : ssh-private-key location, including file name, key that has access to all the nodes.
USERNAME: Your user ID.

```sh
export TARGET_PATH=/root/target
export SITE_MANIFEST=/root/${USERNAME}/site-manifests/site/mysitename
export GLOBAL_MANIFEST=/root/${USERNAME}/global-manifests
export PRIVATE_KEY=/root/${USERNAME}.key
```

#### Rotate certs:
This steps reads the manifests, generates new certificate.yaml, generates .pem files for each
node of the cluster, and copies them to all the nodes.
It also does restart pods with kubernetes, etcd, then makes all cert files on nodes immutable.

```sh
docker run -u root --rm -it \
  -v $TARGET_PATH:/target \
  -v $SITE_MANIFEST:/opt/site-manifests \
  -v $GLOBAL_MANIFEST:/opt/global-manifests \
  -v $PRIVATE_KEY_PATH:/root/.ssh/id_rsa  \
  -e "ansible_user=ubuntu" -e $SITE_TYPE att-comdev/swissknife rotate_certs
```


#### Generate configmaps and secrets:
Generates new configmaps and secrets based on the new certificate.yaml created above.
To run you will need ingress.yaml to be copied to the $TARGET_PATH/certificates folder.
Output of this step are bunch of yaml files that are stored at $TARGET_PATH/cm_secrets.

```sh
docker run -u root --rm -it \
  -v $TARGET_PATH:/target \
  -v $SITE_MANIFEST:/opt/site-manifests \
  -v $GLOBAL_MANIFEST:/opt/global-manifests \
  -v $PRIVATE_KEY_PATH:/root/.ssh/id_rsa  \
  -e "ansible_user=ubuntu" -e $SITE_TYPE att-comdev/swissknife generate_config_maps
```

#### Execute script to patch configmaps and secrets:
Step to execute and patch kubernetes cluster with the yamls generated above
```sh
cd $TARGET_PATH/cm_secrets; bash apply_cm_secret_script.sh
```

#### Delete the pods:
Restart all the anchor and ingress pods to use latest configmaps

```sh
export LABELS="component=etcd-anchor \
    component=kubernetes-apiserver-anchor \
    component=kubernetes-controller-manager-anchor \
    component=kubernetes-scheduler-anchor \
    k8s-app=calico-node \
    k8s-app=calico-kube-controllers \
    application=ingress \
    component=neutron-ovs-agent \
    application=libvirt \
    component=neutron-sriov-agent \
    component=compute"

    for label in $LABELS;
    do kubectl get pods --all-namespaces -l $label | \
    awk 'NR>1{print $1,$2}' | \
    xargs -L 1 kubectl delete pod --grace-period=0 --force -n;
    done
```

#### Remove locks on the certs:
Remove the lock (chattr -l) on the certs
```sh
docker run -u root --rm -it \
  -v $TARGET_PATH:/target \
  -v $SITE_MANIFEST:/opt/site-manifests \
  -v $GLOBAL_MANIFEST:/opt/global-manifests \
  -v $PRIVATE_KEY_PATH:/root/.ssh/id_rsa  \
  -e "ansible_user=ubuntu" -e $SITE_TYPE att-comdev/swissknife unlock_certs
```

#### Remove lock on k8s manifests:
```sh
docker run -u root --rm -it \
  -v $TARGET_PATH:/target \
  -v $SITE_MANIFEST:/opt/site-manifests \
  -v $GLOBAL_MANIFEST:/opt/global-manifests \
  -v $PRIVATE_KEY_PATH:/root/.ssh/id_rsa  \
  -e "ansible_user=ubuntu" -e ${SITE_TYPE} att-comdev/swissknife unlock_k8s_manifests
```

#### To restart the kubelet at any point after rotate\_certs:
```sh
docker run -u root --rm -it \
  -v $TARGET_PATH:/target \
  -v $SITE_MANIFEST:/opt/site-manifests \
  -v $GLOBAL_MANIFEST:/opt/global-manifests \
  -v $PRIVATE_KEY_PATH:/root/.ssh/id_rsa  \
  -e "ansible_user=ubuntu" -e $SITE_TYPE att-comdev/swissknife restart_kubelet <node_name|group_name>
```

#### Backup Certificates
Important - Please take a copy of the certificates.yaml and submit a patchset to the security-manifests
directory or repository.

